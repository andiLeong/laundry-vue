<script setup>
import AdminLayout from '@/components/admin/AdminLayout.vue';
import { useRoute, useRouter } from 'vue-router';
import { ref } from 'vue';
import useFetchOrder from '@/composable/useFetchOrder.js';
import Errors from '@/model/Errors.js';
import useFetchServices from '@/composable/useFetchServices.js';
import BaseInput from '@/components/forms/BaseInput.vue';
import ErrorManager from '@/components/validation/ErrorManager.vue';

const route = useRoute();
const router = useRouter();
const id = ref(route.params.id);
const endpoint = ref(`/api/admin/order/${id.value}`);
const isLoading = ref(false);
const errors = ref({});
const images = ref([]);

const { services } = useFetchServices();
const { loading, order, error } = useFetchOrder(endpoint.value);

function serviceChanged(e) {
    let serviceId = e.target.value;
    order.value.service_id = serviceId;
    order.value.amount = services.value.filter(
        service => service.id === parseInt(serviceId),
    )[0].price;
}

function selectFile(e) {
    console.log(e.target.files);
    for (let i = 0; i < e.target.files.length; i++) {
        images.value.push(e.target.files[i]);
    }
}

function update() {
    const payload = new FormData();
    payload.append('service_id', order.value.service_id);
    payload.append('amount', order.value.amount);
    payload.append('description', order.value.description);
    payload.append('_method', 'patch');
    images.value.forEach(file => {
        payload.append('image[]', file);
    });
    axios
        .post(endpoint.value, payload, {
            headers: { 'Content-Type': 'multipart/form-data' },
        })
        .then(() =>
            router.push({
                name: 'admin-order-detail',
                params: { id: id.value },
            }),
        )
        .catch(error => {
            let err = new Errors(error);
            errors.value = err.handle();
            console.log(errors.value);
            isLoading.value = false;
        });
}
</script>

<template>
    <AdminLayout>
        <main class="flex-1 pb-8">
            <section v-if="order" class="max-w-6xl lg:mx-auto mt-10 mx-4">
                <form @submit.prevent="update">
                    <div class="pt-1">
                        <div class="mb-2">
                            <ErrorManager v-if="errors" :errors="errors" />
                        </div>
                    </div>
                    <div class="space-y-12">
                        <div class="border-b border-gray-900/10 pb-12">
                            <h2
                                class="text-base font-semibold leading-7 text-gray-900"
                            >
                                Order #{{ id }}
                            </h2>

                            <div
                                class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6"
                            >
                                <div class="sm:col-span-3">
                                    <label class="form-label">Service</label>
                                    <select
                                        class="field form-select mt-1"
                                        :value="order.service_id"
                                        @change="serviceChanged"
                                    >
                                        <option disabled value>
                                            please select
                                        </option>
                                        <option
                                            v-for="service in services"
                                            :value="service.id"
                                            :key="service.id"
                                            :selected="
                                                service.id === order.service_id
                                            "
                                        >
                                            {{ service.name }}
                                        </option>
                                    </select>
                                </div>

                                <div class="sm:col-span-3">
                                    <BaseInput
                                        labelClass="form-label"
                                        placeHolder="Amount"
                                        class="mt-1 form-input"
                                        label="Order Amount"
                                        type="number"
                                        v-model="order.amount"
                                    />
                                </div>

                                <div class="col-span-full">
                                    <BaseInput
                                        labelClass="form-label"
                                        placeHolder="Write the order description"
                                        class="mt-1 form-input"
                                        label="Order Description"
                                        type="text"
                                        v-model="order.description"
                                    />
                                    <p
                                        class="mt-3 text-sm leading-6 text-gray-600"
                                    >
                                        Write a few words about the order.
                                    </p>
                                </div>

                                <div class="col-span-full">
                                    <label
                                        for="cover-photo"
                                        class="block text-sm font-medium leading-6 text-gray-900"
                                        >Order Photo</label
                                    >
                                    <div
                                        class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10"
                                    >
                                        <div class="text-center">
                                            <svg
                                                class="mx-auto h-12 w-12 text-gray-300"
                                                viewBox="0 0 24 24"
                                                fill="currentColor"
                                                aria-hidden="true"
                                            >
                                                <path
                                                    fill-rule="evenodd"
                                                    d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z"
                                                    clip-rule="evenodd"
                                                />
                                            </svg>
                                            <div
                                                class="mt-4 flex text-sm leading-6 text-gray-600"
                                            >
                                                <label
                                                    for="file-upload"
                                                    class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500"
                                                >
                                                    <span>Upload a file</span>
                                                    <input
                                                        id="file-upload"
                                                        name="file-upload"
                                                        type="file"
                                                        class="sr-only"
                                                        @change="selectFile"
                                                        multiple
                                                    />
                                                </label>
                                                <p class="pl-1">
                                                    or drag and drop
                                                </p>
                                            </div>
                                            <p
                                                class="text-xs leading-5 text-gray-600"
                                            >
                                                PNG, JPG, GIF up to 2MB
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex items-center justify-end gap-x-6">
                        <button
                            type="submit"
                            class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                        >
                            Save
                        </button>
                    </div>
                </form>
            </section>
        </main>
    </AdminLayout>
</template>

<style scoped></style>